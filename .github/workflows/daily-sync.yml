name: Daily DOMO Sync

on:
  schedule:
    # Run every day at 6 AM PST (14:00 UTC)
    - cron: '0 14 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run Daily Sync
        id: sync
        run: |
          node scripts/daily-sync-domo.mjs > sync-output.txt 2>&1
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DOMO_CLIENT_ID: ${{ secrets.DOMO_CLIENT_ID }}
          DOMO_CLIENT_SECRET: ${{ secrets.DOMO_CLIENT_SECRET }}
          DOMO_ENVIRONMENT: ${{ secrets.DOMO_ENVIRONMENT }}
          DOMO_DATASET_ID: ${{ secrets.DOMO_DATASET_ID }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Check sync status
        id: check_status
        run: |
          if [ ${{ steps.sync.outcome }} == 'success' ]; then
            echo "status=✅ SUCCESS" >> $GITHUB_OUTPUT
            echo "subject=Daily DOMO Sync - Completed Successfully" >> $GITHUB_OUTPUT
          else
            echo "status=❌ FAILED" >> $GITHUB_OUTPUT
            echo "subject=Daily DOMO Sync - FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      - name: Send email report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: ${{ steps.check_status.outputs.subject }}
          to: mhansen@cmgfi.com
          from: CMG Servicing Sync <${{ secrets.SMTP_USER }}>
          body: |
            Daily DOMO Sync Report
            ======================

            Status: ${{ steps.check_status.outputs.status }}
            Date: ${{ steps.date.outputs.date }}
            Workflow: ${{ github.workflow }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Sync Output:
            ------------
            ${{ steps.sync.outputs.stdout }}

            View full logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: sync-output.txt
          priority: normal
